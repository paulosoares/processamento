<?xml version="1.0" encoding="ISO-8859-1"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:s="http://www.springframework.org/schema/security"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd
           http://www.springframework.org/schema/security 
           http://www.springframework.org/schema/security/spring-security-2.0.1.xsd">

	<import resource="classpath*:/META-INF/spring/casSecurity.xml" />
	
	<alias alias="dsSeguranca" name="dataSource" />
	    
    <bean id="casAuthenticationProvider"
    	class="br.jus.stf.estf.decisao.support.security.AuthenticationProvider">
		<s:custom-authentication-provider/>
    	<property name="serviceProperties" ref="serviceProperties" />
    	<property name="key" value="casAuthenticationProviderKey" />
        <property name="userDetailsService" ref="casUserDetailsService" />
        <property name="ticketValidator" ref="ticketValidator" />
    </bean>
	
	<bean id="filterSecurityInterceptor" class="org.springframework.security.intercept.web.FilterSecurityInterceptor">
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="accessDecisionManager" ref="accessDecisionManager"/>
        <property name="objectDefinitionSource">
            <s:filter-invocation-definition-source>
            	<!--<s:intercept-url pattern="/api/**" access="IS_AUTHENTICATED_ANONYMOUSLY" />-->
            	<s:intercept-url pattern="/common/**" access="IS_AUTHENTICATED_ANONYMOUSLY" />
            	<s:intercept-url pattern="/lib/**" access="IS_AUTHENTICATED_ANONYMOUSLY" />
            	<s:intercept-url pattern="/ajuda/**" access="IS_AUTHENTICATED_ANONYMOUSLY" />
            	<s:intercept-url pattern="/mobile/assinador/**" access="RS_ESTFDECISAO-MINISTRO_ESTFDECISAO" />
            	<s:intercept-url pattern="/seam/resource/rest/security/user/logged" access="IS_AUTHENTICATED_ANONYMOUSLY" />
                <s:intercept-url pattern="/**" access="
                	RS_ESTFDECISAO-DECISAO_GERENTE,
                	RS_ESTFDECISAO-MASTER_ESTFDECISAO,
                	RS_ESTFDECISAO-MINISTRO_ESTFDECISAO,
                	RS_ESTFDECISAO-ADMINISTRADOR_ESTFDECISAO,
                	RS_ESTFDECISAO-AVANCADO_ESTFDECISAO,
                	RS_ESTFDECISAO-BASICO_ESTFDECISAO,
                	RS_ESTFDECISAO-AGENDAR_ESTFDECISAO,
                	RS_ESTFDECISAO-MINUTA_ESTFDECISAO,
                	RS_ESTFDECISAO-ASSINAR_ESTFDECISAO,
                	RS_ESTFDECISAO-CONTROLE_VOTOS_ESTFDECISAO,
                	RS_ESTFDECISAO-LIBERAR_PUBLICACAO_ESTFDECISAO,
                	RS_ESTFDECISAO-REVISAO_ESTFDECISAO,
                	RS_ESTFDECISAO-CONSULTA_ESTFDECISAO,
                	RS_ESTFDECISAO-CONSULTA_TODOS_GABINETES_ESTFDECISAO,
                	RS_ESTFDECISAO-IMPRIMIR_ESPECIAL_ESTFDECISAO,
                	RS_ESTFDECISAO-MINISTRO_ESTFDECISAO_GMRW,
					RS_ESTFDECISAO-ADMINISTRADOR_ESTFDECISAO_GMRW,
					RS_ESTFDECISAO-AVANCADO_ESTFDECISAO_GMRW" />   
            </s:filter-invocation-definition-source>
    	</property>
    </bean> 
    
    <!-- bean id="filterSecurityInterceptor" class="org.springframework.security.intercept.web.FilterSecurityInterceptor">
		<property name="authenticationManager" ref="authenticationManager"/>
		<property name="accessDecisionManager" ref="accessDecisionManager"/>
		<property name="objectDefinitionSource">
			<value>
				CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
				PATTERN_TYPE_APACHE_ANT
				/common/**=IS_AUTHENTICATED_ANONYMOUSLY
				/lib/**=IS_AUTHENTICATED_ANONYMOUSLY
				/ajuda/**=IS_AUTHENTICATED_ANONYMOUSLY
				/mobile/assinador/**=IS_AUTHENTICATED_ANONYMOUSLY
				/seam/resource/rest/security/user/logged=IS_AUTHENTICATED_ANONYMOUSLY
				/**=RS_ESTFDECISAO-DECISAO_GERENTE,RS_ESTFDECISAO-MASTER_ESTFDECISAO,RS_ESTFDECISAO-MINISTRO_ESTFDECISAO,RS_ESTFDECISAO-ADMINISTRADOR_ESTFDECISAO,RS_ESTFDECISAO-AVANCADO_ESTFDECISAO,RS_ESTFDECISAO-BASICO_ESTFDECISAO,RS_ESTFDECISAO-AGENDAR_ESTFDECISAO,RS_ESTFDECISAO-MINUTA_ESTFDECISAO,RS_ESTFDECISAO-ASSINAR_ESTFDECISAO,RS_ESTFDECISAO-CONTROLE_VOTOS_ESTFDECISAO,RS_ESTFDECISAO-LIBERAR_PUBLICACAO_ESTFDECISAO,RS_ESTFDECISAO-REVISAO_ESTFDECISAO,RS_ESTFDECISAO-CONSULTA_ESTFDECISAO,RS_ESTFDECISAO-CONSULTA_TODOS_GABINETES_ESTFDECISAO,RS_ESTFDECISAO-IMPRIMIR_ESPECIAL_ESTFDECISAO,RS_ESTFDECISAO-MINISTRO_ESTFDECISAO_GMRW,RS_ESTFDECISAO-ADMINISTRADOR_ESTFDECISAO_GMRW,RS_ESTFDECISAO-AVANCADO_ESTFDECISAO_GMRW			
			</value>
		</property>
	</bean-->

	<bean id="securityContextHolderAwareRequestFilter" class="org.springframework.security.wrapper.SecurityContextHolderAwareRequestFilter">
        <property name="wrapperClass" value="org.springframework.security.wrapper.SecurityContextHolderAwareRequestWrapper"/>
    </bean>
    
	<bean id="bindAuthenticator" class="org.springframework.security.providers.ldap.authenticator.BindAuthenticator">
		<constructor-arg>
			<ref local="initialDirContextFactory" />
		</constructor-arg>
		<property name="userSearch" ref="userSearch" />
	</bean>	
    
    <bean id="initialDirContextFactory"
		class="org.springframework.security.ldap.DefaultInitialDirContextFactory">
		<constructor-arg
			value="ldap://rede.stf.gov.br:389" />
		<property name="managerDn">
			<value>CN=srv-publicacao-bind,OU=Contas de Servicos,OU=CONTAS_ESPECIAIS,DC=rede,DC=stf,DC=gov,DC=br</value>
		</property>
		<property name="managerPassword">
			<value>Q7w@lKz9#x3VbE</value>
		</property>
        <property name="extraEnvVars">
            <map>
                <entry>
                    <key>
                        <value>java.naming.referral</value>
                    </key>
                    <value>follow</value>
                </entry>
            </map>
        </property>		
	</bean>
	
	<bean id="userSearch"
		class="org.springframework.security.ldap.search.FilterBasedLdapUserSearch">
		<constructor-arg index="0">
			<value>ou=usuarios,dc=rede,dc=stf,dc=gov,dc=br</value>
		</constructor-arg>
		<constructor-arg index="1">
			<value>(sAMAccountName={0})</value>
		</constructor-arg>
		<constructor-arg index="2">
			<ref local="initialDirContextFactory" />
		</constructor-arg>
		<property name="searchSubtree">
			<value>true</value>
		</property>
	</bean>
	
	<!-- Configuração que sobrescreve a do arquivo casSecurity.xml do componente cas client 
		 a fim de permitir redirect para a mesma URL requisitada antes da autenticação.
		 A mudança está no valor da propriedade "createSessionAllowed", modificada para "true". -->
	<bean id="exceptionTranslationFilter"
    	class="org.springframework.security.ui.ExceptionTranslationFilter">
        <property name="authenticationEntryPoint" ref="casProcessingFilterEntryPoint" />
        <property name="createSessionAllowed" value="true" />
        <property name="accessDeniedHandler" ref="accessDeniedHandler" />
    </bean>	
    
</beans>